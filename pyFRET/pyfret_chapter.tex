\chapter{Analysis Tools for Single Molecule Confocal Microscopy}
\section{Overview}
This chapter describes the development of pyFRET, an open source library of analysis tools for confocal single molecule spectroscopy. The chaper is structured as follows. Firstly, we describe the analysis algorithms supported by pyFRET, including their theoretical basis and programmatic implementation. Next, we describe the specifics of their implemenation and deployment using pyFRET. Finally, we compare the performance of different analysis techniques, as implemented using pyFRET, to understand their strengths. 

The contributions of this chapter are twofold. Firstly, pyFRET is the first open source software released for smFRET data analysis. This is important as open software facilitates effective benchmarking and comparison of different analysis methods. Secondly, we present the first detailed comparison of different analysis techniques for confocal smFRET. The data collection and analysis methods used by different research groups are currently highly heterogeneous, so this comparison makes an important contribution to our understanding of the best techniques to use for accuarate evaluation of smFRET data.  

\section{Introduction}
\subsection{The Single Molecule Fluorescence Experiment}

XXX Note: a lot of this will be moved to  the introduction chapter ... XXX

As described in Chapter~\ref{chap:intro}, in a confocal smFRET experiment, molecules are labelled with two fluorescent dyes. The emission spectrum of the donor dye ($D$) is chosen to overlap with the excitation spectrum of the acceptor ($A$). When the donor and acceptor are sufficiently close in space, exciting the donor dye results in FRET and fluorescent emission from the acceptor dye. The FRET efficiency, $E$, which describes the proportion of excitation energy transferred from the donor to the acceptor, depends on the distance, $r$ between the two dyes (Eq.~\ref{eq:efficiency}) and $R_0$, the F\"{o}rster distance, a dye dependent constant that describes the dye separation at which 50\% energy transfer is achieved (Fig.~\ref{fig:fig1_instrumentation} C)

\begin{equation}
E = \frac{1}{1 + (\frac{r}{R_0})^6} 
\label{eq:efficiency}
\end{equation}

Consequently, the distance between the two fluorophores can be determined from the ratio of donor and acceptor photons emitted during an excitation event (Eq.~\ref{eq:Eprod}).

\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=5in]{pyFRET/Fig1_schematic.pdf}
      \caption{{\bf Instrumentation for a smFRET experiment.} A) The confocal microscope, excitation and detection apparatus. B) Labelled molecules diffuse through the excitation volume. C) The characteristic sigmoidal dependence of FRET efficiency on dye-dye distance.}
      \label{fig:fig1_instrumentation}
   \end{center}
\end{figure}


Experimentally, a collimated laser beam, is used to illuminate an extremely dilute solution of labelled molecules. When a labelled molecule diffuses through the laser beam, the donor dye is excited and photons are emitted from both donor and acceptor dyes.  Emitted photons are collected through the objective and separated into donor and acceptor streams for collection and analysis (Fig.~\ref{fig:fig1_instrumentation} A, B). 

For a single fluorescent burst, the FRET efficiency, $E$, can be calculated as (Eq~\ref{eq:Eprod}):

\begin{equation}
E = \frac{n_A}{n_A + \gamma \cdot n_D}
\label{eq:Eprod}
\end{equation} 

for $n_A$ and $n_D$ detected acceptor and donor photons respectively and $\gamma$ an experimentally determined instrument-dependent correction factor. During the course of a smFRET experiment, several thousand fluorescent bursts are collected and used to construct FRET efficiency histograms, which cab then be used to identify populations of fluorescent species~\cite{ha96}.

\section{Data Analysis in Confocal smFRET Experiments}
Analysis of smFRET data involves several computational challenges. Firstly, photons emitted by a fluorescent molecule diffusing through the excitation volume must be identified against a noisy background. Secondly, identified bursts must be denoised, including removal of background auto-fluorescence and donor-acceptor crosstalk. Fluorescent bursts that are distorted by photobleaching or other photophysical artifacts should be identified and excluded. Multiple methods of burst selection and analysis have been developed and applied to the analysis of smFRET data~\cite{weiss00, deniz01, gell06, nir06, kapanidis05, muller05, doose07, kudryavtsev2012, eggeling01}. However, software for analysis of smFRET data has thus far been developed on an ad hoc basis, with individual groups preparing and maintaining their own analysis scripts, leading to problems typical of research programming projects~\cite{wilson06, merali10}. 

\subsection{Continuous Excitation}
\paragraph{Time-binned Data}
In the most simple smFRET experiment, fluorescently labelled molecules are excited by a laser that will excite the donor dye; all photons reaching the detectors during data acquisition binned as they are received into time-bins of length similar to the expected dwell-time of a molecule in the confocal volume (for freely diffusing molecules, a bin-time of 1 ms is typically used). Event selection then simply involves identifying time-bins that contain sufficient photons to meet a specified criterion. Two thresholding criteria are in common use. AND thresholding selects time bins for which $n_D > T_D$ AND $n_A > T_A$ for $n_D$ and $n_A$ photons in the donor and acceptor channels respectively, and $T_D$ and $T_A$ the donor and acceptor thresholds. In a similar manner, SUM thresholding considers the sum of photons observed in the donor and acceptor channels, selecting time bins for which $n_D + n_A > T$.

\paragraph{Fluorescent Burst Data}
Although using time-bins that are matched to the dwell-time of molecules in the confocal volume is simple, it is not ideal, as some bursts will be split over several bins, so may be counted as separate events, or not considered for analysis. More sophisticated event selection algorithms, typically called burst search algorithms~\cite{nir06}, bin photons on a time-scale much shorter than the typical dwell time in the confocal volume and then scan the resultant photon stream for bursts of a specified duration and brightness. pyFRET implements both All Photons Burst Search (APBS) and a Dual Channel Burst Search (DCBS) algorithms for both ALEX data and for simple FRET data, as originally described~\cite{nir06}.

In APBS burst search for FRET data, photons from both donor and acceptor channels are considered together. A burst is defined according to three constants: $T$, the averaging window; $M$, the minimum number of photons within window $T$; and $L$, the minimum total number of photons required for an identified burst to be retained. These three values are used in a two-step process for burst identification.

Firstly, ``the start (respectively, the end) of a potential burst is detected when the number of photons in the averaging window of duration T is larger (respectively, smaller) than the minimum number of photons M."~\cite{nir06}.

The DCBS burst search is similar, but considers the donor and acceptor channels separately. For a burst to be accepted in DCBS, both channels must simultaneoulsy meet the running sum criterion, allowing exclusion of single colour bursts and bursts where one fluorophore bleaches.

\subsection{Alternating Laser Excitation}
\paragraph{Time-binned Data}
A more sophisticated smFRET experiment uses Alternating Laser Excitation (ALEX) during data acquisition. In this method, the diffusing fluorescent molecules are subjected to excitation from both two lasers in rapid alternation~\cite{kapanidis05}. One laser excites the donor fluorophore and the other can directly excite the acceptor fluorophore. The alternation of the laser excitation is fast on the timescale of molecular dwell-time in the confocal volume, allowing a single fluorescent molecule to receive multiple cycles of donor-acceptor direct excitation.

Instead of the two photon streams -- donor and acceptor photons -- observed in a simple smFRET experiment, in a confocal ALEX experiment, there are four streams: $F_{D_{ex}}^{D_{em}}$, $F_{D_{ex}}^{A_{em}}$, $F_{A_{ex}}^{D_{em}}$, $F_{A_{ex}}^{A_{em}}$. $F_{D_{ex}}^{D_{em}}$ and $F_{D_{ex}}^{A_{em}}$, respectively donor and acceptor emission during donor excitation, are analogous to the two original donor and acceptor photon streams in a smFRET experiment. $F_{A_{ex}}^{A_{em}}$ records acceptor emission during direct acceptor excitation, whilst $F_{A_{ex}}^{D_{em}}$ records donor emission during acceptor excitation. The presence of these extra channels provides additional information about the labelling state of molecules giving rise to fluorescent bursts, allowing exclusion of bursts from molecules lacking one of the FRET labels and bursts where one of the labels was bleached. Selection based on direct excitation of both fluorophores also removes the biases caused by simple AND or SUM thresholding. 

\paragraph{Fluorescent Burst Data}
The burst search algorithms implemented for ALEX data work in a similar manner. In the ALEX APBS method, bursts are identified by considering the total number of fluorescent photons $F_{total} = F_{D_{ex}}^{D_{em}} + F_{D_{ex}}^{A_{em}} + F_{A_{ex}}^{A_{em}}$ in each time bin. Bursts are identified where the running sum (calculated using the  $F_{total}$ photon stream) in the averaging window $T$ exceeds $M$. The DCBS method considers donor excitation photons $F_{D_{ex}}^{D_{em}} + F_{D_{ex}}^{A_{em}}$ separately from photons emitted during direct acceptor excitation $F_{donor} = F_{A_{ex}}^{A_{em}}$, requiring that the running sum exceeds $M$ for both $F_{donor}$ and $F_{A_{ex}}^{A_{em}}$.


% simple interface for data analysis
% tools for burst selection, denoising, analsysis, visualisation
% short but contains all key methodologies  
\section{Development of Scientific Software}

A lot has been written concerning the development and maintenance of software used by academic researchers. Compared with code written by professional software engineers, scientists are often described as writing poor quality code that is inefficient, badly documented and difficult to use. Software for smFRET analysis has historically experienced several of these issues, which has slowed innovation in the field.

% Problems with the lack of open source software and collaboration: Keep for now as want to restructure this section
% - poorly maintained code
% - code that is not reused
% - difficult to adopt new techniques as code must be implemented from scratch
% - difficult to reproduce others' results -- no access to analysis methods
% - difficult for new groups to be established as new code must be written to reimplement basic analysis techniques
% - results beween groups not comparable
% - unclear how other groups performed analysis
% - data analysis seen as secondary to experimental techniques, but methods of anlaysis can significantly alter expt outcomes, often disregarded in papers.

%Firstly: reinventing the wheel

Firstly, smFRET software used by different research groups often requires ``reinventing the wheel"~\cite{mirams13}. Within smFRET research groups, programming ability is not a standard skill, despite the need for sophisticated data analysis and use of custom data collection hardware. It is common for researchers with programming skills to maintain their own series of data-analysis scripts which may be wholly dependent on particular hardware tools or analysis packages. Other researchers, who may lack the skills to maintain and develop even simple scripts, are dependent on black-box techniques provided by their colleagues. Consequently, data analysis is dependent on scripts written and maintained by just a few researchers. Loss of programming expertise when these team members leave can result in significant difficulties for the remaining group members, who are then dependent on poorly documented code that they do not fully understand how to use. Furthermore, the lack of available open source software often requires new researchers in the field of smFRET to completely reimplement standard analysis techniques in order to become independently productive.    

%Secondly: productivity
Secondly, the need for many researchers to develop and maintain their own analyis tools has significant impact on research productivity. The requirement to reimplement standard analysis techniques consumes valuable time that could better be used in experimental research or in developing and benchmarking improved analysis tools. Furthermore, most researchers have no formal training in software engineering, with the result that analysis software can vary hugely in quality and is frequently poorly documented and maintained, making it difficult for other researchers to understand and use. New analysis scipts are often added in an ad hoc manner, with the result that straighforward tasks are performed using an unweildy mess of spaghetti code, transforming simple modifications into complex undertakings requring significant time investmenent. Poorly maintained code adds an additional barrier to open sharing of resources as groups are embarrassed to share low-quality software.  

% Finally: reproducibility
Finally, there is the issue of research reproducibility. Different research groups use widely differing tools to complete relatively similar tasks. New methods of data collection and analysis are frequently developed~\cite{kapanidis05, nir06, sisamakis2010}. However, when software is not released to the community, it is difficult for researchers, who must often implement poorly described methodologies entirely from scratch, to verify results or to adopt new techniques in their own research. As a consequence, new techniques are poorly benchmarked, making it difficult to understand whether a new analysis adds quality or merely complexity, whilst adoption of useful new methods is relatively slow. These three issues of productivity, reliability and reproducibility, all linked to the problem of poorly maintained softwared and lack of software development skills, are now becoming a key bottleneck in smFRET research.  


\section{pyFRET: Design and Implementation}
Here we present pyFRET, an open-source python library, for the analysis of smFRET data. To our knowledge, this is the first open source software ever released by the smFRET research community. pyFRET is a small library that provides a toolkit facilitating all key steps in analysis of smFRET data: burst selection; cross-talk subtraction and burst denoising; data visualisation; and construction and simple fitting of FRET efficiency histograms. In providing this toolkit to the smFRET research community, we hope to facilitate the wider adoption of smFRET techniques in biological research as well as providing a framework for open communication about and sharing of data analysis tools.

\subsection{Code Layout and Design}
pyFRET provides four key data structures (classes) for manipulation of smFRET data. The FRET data object describes two fluorescence channels, corresponding to time-bins containing photons collected from donor (the donor channel, $D$) and acceptor (the acceptor channel, $A$) fluorophores. The ALEX data object describes four fluorescence channels, corresponding to the four temporal states in a smFRET experiment using Alternating Laser Excitation (ALEX), namely the donor channel when the donor laser is switched on ($D_D$); the donor channel when the acceptor laser is switched on ($D_A$); the acceptor channel when the donor laser is on ($A_D$); and the acceptor channel when the acceptor laser is on ($A_A$). These data channels are implemented as numpy arrays, allowing efficient computations and selection operations. The data structure can readily be expanded to include data from more detectors, which is needed in e.g. three-colour or anisotropy measurements.

Two similar classes are used for fluorescence bursts identified using the burst search algorithms. In addition to the donor and acceptor channels, the FRET bursts class type holds three additional arrays, giving the first and last bin of each burst, and the duration of each burst. These three new attributes are similarly present in the ALEX bursts object, in addition to the four fluorescent channels in the ALEX data object. In addition to the methods present for the simple FRET and ALEX objects, the burst data objects also implement methods to plot burst duration and to analyse recurrent bursts (RASP). 

The data analysis workflow is illustrated in Fig.~\ref{fig:fig2_workflow} Following initialization of data objects, a single line of code performs background subtraction, event selection, cross-talk correction and calculation of the FRET efficiency. Likewise, simple but high-quality figures (see Fig.~\ref{fig:fig3_sample_results} for examples) can be generated in a single step.

\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=6in]{pyFRET/workflow_new.pdf}
      \caption{{\bf Typical workflow for data analysis using pyFRET.}}
      \label{fig:fig2_workflow}
   \end{center}
\end{figure}

\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=6in]{pyFRET/6bp_example.pdf}
      \caption{{\bf Figures made using pyFRET.} A) A Proximity Ratio histogram. B) A scatter-plot of FRET efficiency and fluorophore stoichiometry from ALEX data. C) A heatmap of event frequencies.  D) A 3D plot of event frequencies.}
      \label{fig:fig3_sample_results}
   \end{center}
\end{figure}


\subsection{Simple Event Selection and Denoising}
\subsubsection{FRET Data}
As described above, the most straighforward method of smFRET data analysis of data from a continuous excitation experiement uses time-binned data and simply selects time-bins where the photon count exceeds some stated threshold. This threshold can be over  both the donor and acceptor channels (AND thresholding) or over the sum of photons in both donor and acceptor channels. These thresholding techniques can be implemented using a single call to a pyFRET function: 

\begin{lstlisting}
# Simple thresholding

# define thresholds
Td = 20  # donor threshold
Ta = 20  # acceptor threshold
T = 50   # combined threshold

# AND thresholding
data.threshold_AND(Td, Ta)

# SUM thresholding
data.threshold_SUM(T)
\end{lstlisting}

Following event selection, a simple method of denoising is to subtract from each selected event the average background autofluorescence observed in each channel and the average cross-talk between the two channels:

\begin{lstlisting}
# Simple denoising

# removing autofluorescence
auto_donor = 0.5     # donor autofluorescence
auto_acceptor = 0.3  # acceptor autofluorescence
my_data.subtract_bckd(auto_donor, auto_acceptor)

# removing cross-talk
cross_DtoA = 0.05   # fractional cross-talk from donor to acceptor
cross_AtoD = 0.01   # fractional cross-talk from acceptor to donor
my_data.subtract_crosstalk(cross_DtoA, cross_AtoD)
\end{lstlisting}

This is the simplest method for event selection and denoising. However, it has several limitations. In particular, simple subtraction of constant values can lead to unphysical artifacts such as negative and fractional photon counts. Furthermore, the simple thresholding criteria for event selection are known to be biased~\cite{nir06}, so can distort downstream data analysis. 

\subsubsection{ALEX Data}
pyFRET implements ALEX event selection as described in the original publication~\cite{lee06}. In brief, bursts are initially selected using a selection criterion based on the total number of photons emitted during donor and acceptor excitation:
 $F_{D_{ex}}^{D_{em}} + F_{D_{ex}}^{A_{em}} > T_D$ AND $F_{A_{ex}}^{A_{em}} > T_A$.

 Following this initial event selection, a second selection step is performed, based on the ratio of photons emitted during donor and acceptor excitation periods. The photon stoichiometry, $S$ is calculated for each burst as:

\begin{equation}
S = \frac{F_{D_{ex}}^{D_{em}} + F_{D_{ex}}^{A_{em}}}{F_{D_{ex}}^{D_{em}} + F_{D_{ex}}^{A_{em}} + F_{A_{ex}}^{A_{em}}}
\label{eq:Eprod_ALEX}
\end{equation}

Events for which the stoichiometry is either very close to one or very close to zero, indicating presence of only the donor or acceptor fluorophore respectively can be excluded using a second event selection criterion: $S_{min} < S < S_{max}$

Following event selection, remaining bursts can be corrected for photon leakage and direct excitation contributions. A two-dimensional scatter plot of FRET efficiency $E$ and stoichiometery $S$ is then produced, including one-dimensional histograms of both $E$ and $S$. 

pyFRET allows each of these steps to be performed separately, however they can also be combined into a single step combining event selection, denoising, FRET efficiency calculation and plotting:

\begin{lstlisting}
# Simple ALEX analysis

g_factor = 0.95 # instrumental gamma factor
S_min = 0.2     # min accepted value of S
S_max = 0.8     # max accepted value of S
filepath = "path\to\my\file"
filename = "scatter_plot"
ALEX_data.scatter_hist(S_min, S_max, gamma=g_factor, save=True, filepath=filepath, imgname=filename, imgtype="png")
\end{lstlisting}

Example ALEX analysis scripts can be found in the supplementary information.

\subsection{Burst Search Algorithms}
pyFRET implements busrt search algorithms for both continuous excitation and ALEX experiemnts. As described above, to use a burst search algorithm effectively, phtotons must be binned into time-bins of duration much shorter than the average dwell time of a molecule in the confocal volume. Bursts are first identified through an initial scan of the burst stream, to identify windows in which the number of photons observed exceeds some threshold. In pyFRET, this initial search is performed using the convolve method from numpy~\cite{numpy11} to provide a running sum across windows of $T$ time-bins. Following initial burst identification, a burst is retained if it contains more than $L$ photons~\cite{nir06}.

Example code for running a burst search algorithm is shown below:

\begin{lstlisting}
# Burst search using FRET data

# required parameters
T = 50             # time window (bins)
M = 50             # first threshold
L = 60             # second threshold

# calling APBS algorithm
bursts_APBS = FRET_data.APBS(T, M, L)
\end{lstlisting}

\section{RASP: Recurrence Analysis of Single Particles}
A recent innovation in confocal smFRET is Recurrence Analysis of Single Particles (RASP)~\cite{hoffmann11}. RASP exploits the fact that fluorescent bursts occurring close in time are more likely to be come from the same molecule diffusing back through the confocal volume than from an independent molecule. This can be used to determine interconversion kinetics and to test whether broad peaks in the E histogram derive from overlapping static populations.

RASP is a two-step process. First, initial bursts ($b_1$) with a FRET efficiency $E_{b1}$ within some defined range $\Delta(E_{b1})$ are identified. Secondly, bursts ($b_2$) occurring within a time interval (called the recurrence interval) $T = (t_1, t_2)$ of $b_1$ are identified. Analysis of the distribution of FRET efficiencies in $b_2$, the population of recurrent bursts, provides information about the interconversion rate between subpopulations. The rates constants of interconversion can be extracted by fitting the relative subpopulations as a function of interval time.

pyFRET implements RASP using array masking, to allow efficient selection of relevant bursts. RASP can be called in a single step from a FRET bursts or ALEX bursts object, and a loop can readily be made to repeat the process at different time intervals:

\begin{lstlisting}
# RASP

# initial E range: 0.4 < E < 0.6
Emin = 0.4
Emax = 0.6

# Time interval for re-occurrence
# given in number of bins
Tmin = 1000
Tmax = 10000

# selecting re-occurring bursts
recurrent_bursts = bursts_APBS.RASP(Emin, Emax, Tmin, Tmax)

# histogram of re-occurring bursts
recurrent_bursts.build_histogram(filepath, csvname, gamma=g_factor)
\end{lstlisting} 

\subsection{Compatibilities}
pyFRET is written in Python. Both python 2 (v2.7) and python 3 (v3.3) are supported. pyFRET requires four further python libraries, namely numpy and scipy for data manipulation, matplotlib for data visualisation and scikit-learn for peak fitting. We recommend using the free Anaconda package bundle (\url{https://store.continuum.io/cshop/anaconda/}) to install these dependencies. Detailed installation instructions can be found in the pyFRET documentation (\url{http://pyfret.readthedocs.org/en/latest/tutorial.html#installing-pyfret}). pyFRET was written and tested in a Linux environment. However, it was written to be platform independent and has also been used successfully on both Apple and Windows machines.

The lack of Open Source software in the smFRET community has led to a proliferation of esoteric file-types used for data collection and storage. To make pyFRET as usable as possible for a wide range of smFRET researchers, we provide file parsers for simple .csv and .txt file formats, as well as our custom binary format. The pyFRET data structures can be initialised using simple python arrays of time-binned photons, for users whose file format is not currently supported. The tutorial and supplementary information provide example scripts for parsing common filetypes into pyFRET objects.

\section{Experimental Methods}
\subsection{Benchmarking the Gaussian Fitting Using Simulated Datasets}
To test the ability of the fitting algorithms to distinguish fluorescent populations with similar FRET efficiencies, we generated simulated datasets consisting of mixtures of FRET bursts with a known FRET efficiency and population size. These bursts were then fitted using pyFRET's two component mixture model and the results compared to the known input FRET efficiencies and population sizes. The python script used to generate and fit these datasets can be found XXXX. 

\subsection{Data to Evaluate the Simple Event Selection Algorithms}
We tested the pyFRET library using DNA duplexes dual-labelled with Alexa Fluor 488 and Alexa Fluor 647. The duplex sequences and labelling sites are shown in Tables~\ref{tab:donor} and~\ref{tab:acceptors}. Labelled duplexes were diluted to a concentration of 50 pM in TEN buffer (10 mM Tris, 1mM EDTA, 100 mM Nacl), pH 8.0, containing 0.0001 \% Tween-20. FRET data were collected for 15 minutes using continuous excitation at 488 nm at a power of 80 mW. Collected photons were binned online in intervals of 1 ms and stored in files of 10000 bins. To process the data, AND thresholding was performed using thresholds $N_D = 10$ and $N_A = 10$. SUM thresholding used a threshold $N = 20$. For FRET efficiency calculation the $\gamma$-factor was 0.95.

ALEX data were collected for 15 minutes using alternating excitation at 488 and 640 nm, with respective laser powers of 80 and 70 mW, and a modulation rate of 0.1 ms, a dead-time of 0.1 $\mu$s and a delay compensation of 3 $\mu$s. ALEX data were then binned in intervals of 1 ms. The scripts and configuration files used to analyse these data using pyFRET can be found XXX.

\begin{table}[!ht]
\caption{
\bf{Donor DNA Sequence}}
\begin{tabular}{|l|l|}
\hline
Construct & Sequence \\
\hline
Donor & TACTGCCTTTCTGTATCGC{\bf 5}TATCGCGTAGTTACCTGCCTTGCATAGCCACTCATAGCCT \\
\hline
\end{tabular}
\begin{flushleft}
DNA sequence of the donor-labelled strand, where {\bf 5} is a deoxy-T nucleotide, labelled with Alexa Fluor 488 at the C6 amino position.
\end{flushleft}
\label{tab:donor}
\end{table}

\begin{table}[!ht]
\caption{
\bf{Acceptor DNA Sequences}}
\begin{tabular}{|l|l|}
\hline
Separation / bp & Acceptor Sequence \\
\hline
4 & AGGCTATGAGTGGCTATGCAAGGCAGGTAACTACGCGATAAGCGA\bf{6} \\
6 & AGGCTATGAGTGGCTATGCAAGGCAGGTAACTACGCGATAAGCGATA\bf{6} \\
8 & AGGCTATGAGTGGCTATGCAAGGCAGGTAACTACGCGATAAGCGATACA\bf{6} \\
10 & AGGCTATGAGTGGCTATGCAAGGCAGGTAACTACGCGATAAGCGATACAGA\bf{6} \\
12 & AGGCTATGAGTGGCTATGCAAGGCAGGTAACTACGCGATAAGCGATACAGAAA\bf{6} \\
\hline
\end{tabular}
\begin{flushleft}
Preparing the dual-labelled dsDNA. An acceptor-labelled ssDNA, with the sequence shown was annealed to the indicated donor construct, to yield a dual-labelled construct with the labels separated by the given number of base pairs. In the displayed acceptor-strand sequences, {\bf 6} is a deoxy-T nucleotide, labelled with Alexa Fluor 647 at the C6 amino position.
\end{flushleft}
\label{tab:acceptors}
\end{table}

\subsection{Data to Evaluate Event Selection Using the Burst Search Algorithms}
To test the burst search algorithms, we collected data under both ALEX and FRET conditions. Data were collected for 10 minutes, using laser powers of 130 $\mu$W in both donor and acceptor excitation. For FRET data collection, laser illumination by the donor laser was continuous and the data were binned online into time bins of 50 $\mu$s, roughly 5 \% of the duration of the average burst from a freely diffusing molecule. The acceptor laser was not used. For ALEX data collection, photons were similarly binned online into time bins of 50 $\mu$s length, but the laser modulation rate was increased to 50 $\mu$s, with a dead-time of 0.1 $\mu$s and a delay compensation of 3 $\mu$s, corresponding to 2 modulations per short time bin. 

To evaluate the effect of bin-time on performance of the burst search algorithms, a further dataset was collected using FRET excitation on the 6 bp duplex. For this dataset, data were collected for 10 minutes using the 488 nm laser at 130 $\mu$W. Data were binned into time bins of 10 $\mu$s, allowing for re-binning into longer time-bins as required.

Unless otherwise specified, DCBS was carried out using parameters $T = 20$ bins, $L = 10$ and $M = 10$; APBS was carried out using parameters $T = 20$ bins, $L = 20$ and $M = 20$.

\subsection{Performance Analysis Using Mixtures of DNA Duplexes}
To test the accuracy of the burst search algorithms, we collected ALEX data from mixtures of two DNA duplexes at known concentration ratios. The 4, 8 and 12 bp duplexes were used. Samples were prepared containing a mixture of two duplexes in TEN buffer with a total DNA concentration of 80 pM, divided in either a 3 : 1 ratio (high concentration 60 pM, low concentration 20 pM) or a 1 : 1 ratio (both components 40 pM). Data were collected under ALEX excitation for 10 minutes, using 50 $\mu$s time-bins as described above. The data were later re-binned into 1 ms time-bins, to compare performance of burst search and simple thresholding in separating the two populations.  


\subsection{Testing the RASP Algorithm}
To test the RASP Algorithm, a 1:1 mixture of 6 bp and 12 bp duplex was prepared to a total DNA concentration of 50 pM. A 400 $\mu$L aliquot of the dilute solution was placed in one chamber of a lidded, chambered coverslide (LabTex) to reduce evaporation during the measurement. FRET data were collected for 600 minutes using continuous excitation at 488 nm at a power of 140 $\mu$W. Collected photons were binned online in intervals of 50 $\mu$s and stored in files of 1000000 bins. Events were identified using APBS burst selection was used, with the lower thresholds of $L = 10$ and $M = 10$ to maximise the number of detected events. RASP was performed on the selected events, using the parameters given in Table~\ref{tab:RASP}. 

\begin{table}[!ht]
\caption{
\bf{RASP Parameters}}
\begin{tabular}{|l|l|}
\hline
Parameter & Value \\
\hline
T & 20 \\
M & 10 \\
L & 10 \\
$E_{min}$ & 0.65 \\
$E_{max}$ & 0.85 \\
$\Delta$T & 1 ms \\
\hline
\end{tabular}
\begin{flushleft}
Parameters used in RASP analysis of the 6 bp duplex - 12 bp duplex mixture.
\end{flushleft}
\label{tab:RASP}
\end{table}

\section{Performance Analysis of smFRET Analysis Algorithms}

\subsection{Evaluating Performance with DNA Duplexes}
\paragraph{Simple Algorithms}
We tested the pyFRET library using DNA duplexes dual-labelled with Alexa Fluor 488 and Alexa Fluor 647. The duplex sequences, dye attachment sites and dye-dye separations are shown in Tables~\ref{tab:donor} and~\ref{tab:acceptors}. Event selection and denoising, calculation of FRET efficiency and the plotting and fitting of FRET efficiency histograms were performed using pyFRET. The results, shown in Fig.~\ref{fig:fig4_AND_plots} for FRET data and Fig.~\ref{fig:fig5_ALEX_plots}, demonstrate that even using the simplest event selection and denoising techniques, pyFRET is able to effectively fit histograms from single FRET populations (Fig.~\ref{fig:fig4_AND_plots} and Fig.~\ref{fig:fig5_ALEX_plots} A - E), to reproduce the characteristic sigmoidal FRET efficiency curve (Fig.~\ref{fig:fig4_AND_plots} and Fig.~\ref{fig:fig5_ALEX_plots} F).

\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=6in]{pyFRET/FRET_AND.pdf}
      \caption{{\bf Analysis of FRET data from DNA duplexes using pyFRET.} A - E: Fitted FRET histograms from DNA duplexes labelled with a dye-dye separation of 4, 6, 8, 10 and 12 base pairs respectively. F) Characteristic sigmoidal curve of FRET efficiency against dye-dye distance.}
      \label{fig:fig4_AND_plots}
   \end{center}
\end{figure}

\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=6in]{pyFRET/FRET_ALEX.pdf}
      \caption{{\bf Analysis of ALEX data from DNA duplexes using pyALEX.} A - E: Fitted FRET histograms from DNA duplexes labelled with a dye-dye separation of 4, 6, 8, 10 and 12 base pairs respectively. F) Characteristic sigmoidal curve of FRET efficiency against dye-dye distance.}
      \label{fig:fig5_ALEX_plots}
   \end{center}
\end{figure}


\paragraph{Burst Search Algorithms}
We tested the pyFRET burst search algorithms using data collected from the same DNA duplexes but using a shorter bin-time. Sample results, from DCBS analysis of both FRET and ALEX data, and APBS analsysis of ALEX data are shown in Fig.~\ref{fig:burst_search}. APBS analysis of the FRET burst data is not shown, as the presence of a zero peak hampered fitting of the low-FRET species. The characteristic sigmoidal FRET efficiency curves generated from DCBS analysis of all five duplexes are shown in Fig.~\ref{fig:fig6_Eplots} A (FRET data) and B (ALEX data).

\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=6in]{pyFRET/burst_search.pdf}
      \caption{{\bf Testing the burst search algorithms.} A) Fitted FRET histograms from DCBS on FRET data. B) Fitted FRET histograms from APBS on ALEX data. C) Fitted FRET histograms from DCBS on ALEX data. In A-C histograms from left to right are derived from 12 bp, 10 bp, 8 bp, 6 bp and 4 bp duplexes respectively. Histograms from APBS on FRET data are not shown, as the large zero peak hampers gaussian fitting when the FRET efficiency is low.}
      \label{fig:burst_search}
   \end{center}
\end{figure}


\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=6in]{pyFRET/Bp_vs_E.pdf}
      \caption{{\bf Plot of FRET Efficiency vs dye-dye separation.} A) FRET data, analysed using the DCBS burst search algorithm. B) ALEX data, analysed using the DCBS burst search algorithm. C) Comparison of different methods. Blue circles and red triangles show ALEX and FRET burst data respectively; green crosses and open circles show simple thresholded data from ALEX and FRET experiments respectively.}
      \label{fig:fig6_Eplots}
   \end{center}
\end{figure}

\subsection{Evaluating the Burst Search Algorithms}
In addition to demonstrating the functionality of the burst search algorithms, we have performed a comprehensive analysis of the impact of bin-time, threshold and detection window on the performance of the burst search algorithms. To our knowledge, this is the first time that such an analysis has been performed, and hence provides useful insight to other researchers depending on the performance of these algorithms.

Burst search algorithms were developed as an improvement to the simple thresholding technique, designed to reduce inaccuracies caused by photobleaching and by long bursts being split over multiple time-bins. To assess the improvement in data quality as a result of using the burst search algorithm, we collected data from the 6 bp duplex using time-bins of 10 $\mu$s, which could then be re-binned into longer time-bins for comparative analysis. Analysis was performed using both APBS and DCBS burst search algorithms on FRET data. For APBS, thresholds of $M=20$ and $L=20$ were used; the thresholds used for DCBS were $M = 10$ and $L = 10$. As the bin-time was varied, the minimum burst duration $T$, given in number of bins, was also varied, to keep the minimum burst duration to a constant time of 1 ms. The bin lengths and their corresponding value of T are shown in Table~\ref{tab:bin-times}. The results, shown in Fig.~\ref{fig:fig7_binning} A (DCBS) and B (APBS) are surprising. When the minimum time-interval for burst detection is not varied, the performance of the algorithm is essentially unaffected by the bin-times used: for both APBS and DCBS algorithms, the resultant FRET efficiency histograms are extremely similar, whether many short bins or a few long bins are searched.


\begin{table}[!ht]
\caption{
\bf{Bin-times}}
\begin{tabular}{|l|l|}
\hline
Bin-time / $\mu$s & T / bins \\
\hline
10 & 100 \\
20 & 50 \\
40 & 25 \\
50 & 20 \\
100 & 10 \\
500 & 2 \\
1000 & 1\\
\hline
\end{tabular}
\begin{flushleft}
Bin lengths and the corresponding minimum burst duration used to evaluate the effect of bin-time on burst search performance.\end{flushleft}
\label{tab:bin-times}
\end{table}

Secondly, we evaluated the effect of the search window T on burst search performance. For a fixed bin-time of 50 $\mu$s, we varied the required burst duration T between 100 $\mu$s (2 bins) and 1000 $\mu$s (10 bins). The results, shown in Fig.~\ref{fig:fig7_binning} C for the DCBS algorithm are again surprising. Across all values tested, the shape of the FRET efficiency histogram is unaffectd by the size of the burst search window. The peak areas are also relatively unaffected by the search window size: the very shortest window of 100 $\mu$s retains only the brightest bursts, resulting in a slightly reduced peak area; other than this the number of detected events is not significantly altered. An analysis of DCBS and APBS on ALEX data showed similar results (Fig.~\ref{fig:fig7_binning} D - F), although the reduction in peak area when the time window is shortest (100 $\mu$s) is more pronounced (Fig.~\ref{fig:fig7_binning} F). This lack of dependence on the burst search parameters ensures that conclusions drawn are independent of the thresholding parameters used.

\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=6in]{pyFRET/window_effect.pdf}
      \caption{{\bf Evaluating the effect of detection window and bin time on the DCBS burst search algorithm for FRET and ALEX data.} A - C show analysis of FRET data. D - F show analysis of ALEX data. A) Varying the length of the time-bin has little effect on the performance of the DCBS algorithm. B) Varying the length of the time-bin has little effect on the performance of the APBS algorithm. C) Reducing the length of the minimum detection window used in DCBS selects for very bright bursts. For very short windows, this reduces the number of detected bursts but does not affect the calculated FRET efficiency. D) Varying the length of the time-bin has little effect on the performance of the DCBS algorithm. E) Varying the length of the time-bin has little effect on the performance of the APBS algorithm. D) Reducing the length of the minimum detection window used in DCBS selects for very bright bursts.}
      \label{fig:fig7_binning}
   \end{center}
\end{figure}

Finally, we evaluated the effect of the thresholds M and L on the performance of the DCBS algorithm for both FRET and ALEX data using the high-FRET 6 bp duplex. We systematically varied the thresholds used in burst search analysis, then evaluated their effect on the fitted peak area and FRET efficiency. The results, shown in Fig.~\ref{fig:fig8_heatmaps}, display several interesting features. Firstly, the decline in peak area with increased threshold is striking for both FRET (Fig.~\ref{fig:fig8_heatmaps} C) and ALEX (Fig.~\ref{fig:fig8_heatmaps} D) data, suggesting that the lowest possible values of L and M should be used, to maximise the data retained. Secondly, increasing the thresholds systematically reducuces the calculated FRET efficiency for the FRET dataset (Fig.~\ref{fig:fig8_heatmaps} A). This is caused by the DCBS algorithm selecting against bursts that have a low donor count, as they do not meet the initial threshold M. This effect is not seen in DCBS on ALEX data (Fig.~\ref{fig:fig8_heatmaps} B), as events are selected based on photons emitted during direct donor and acceptor excitation, so there is no bias towards intermediate FRET efficiencies.

\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=6in]{pyFRET/heatmaps.pdf}
      \caption{{\bf Heatmaps showing the effect on calculated FRET efficiency and peak area of varying the burst search thresholds L and M.} A) Calculated FRET efficiency from DCBS analysis of FRET data. B) Calculated FRET efficiency from DCBS analysis of ALEX data. Missing values in B) are the result of two few events being retained for a gaussian fit to be performed. C) Calculated peak area from DCBS analysis of FRET data. D) Calculated FRET efficiency from DCBS analysis of ALEX data.}
      \label{fig:fig8_heatmaps}
   \end{center}
\end{figure}

We note that, when used on FRET data, the APBS and DCBS burst search algorithms perform in an analogous manner to simple AND and SUM thresholding. Consequently, they retain the well-known disadvantages of these thresholding methods~\cite{murphy14}: specifically, APBS retains a zero-peak caused by donor-only labelled molecules, whereas DCBS is biased against extreme FRET efficiencies, distorting the FRET efficiency histogram. ALEX data does not display these biases, as the direct excitation of both fluorophores allows events to be selected independently of their FRET efficiencies. The effect of these biases in analysis of simple FRET data can be seen in Fig.~\ref{fig:fig6_Eplots} C, which overlays the calculated FRET efficiency curves for DCBS analysis of FRET and ALEX data. The curves for both AND-thresholded FRET data and DCBS burst selection of FRET data are distorted towards intermediate FRET efficiencies; ALEX data does not show this distortion. Consequently, ALEX is a superior technique and should be used when available.

\subsection{Evaluating Performance of the Gaussian Mixture Model}
We used a combination of simulated and experimental data to benchmark the performance of the Gaussian fitting method when presented with multiple FRET populations. Firstly, we simulated FRET bursts drawn from a mixture of two FRET populations, with mean FRET efficiencies ranging from 0.1 to 0.9. These bursts were fitted with a two component Gaussian mixture model and the fits and FRET histograms overlaid. Example fits, shown in Fig.~\ref{fig:fig_benchmarking} A and B, demonstrate that where peaks are well separated (Fig.~\ref{fig:fig_benchmarking} A), they are correctly distinguished by the fitting protocol. However, when there is significant overlap between the FRET peaks (Fig.~\ref{fig:fig_benchmarking} B), there is insufficient information to distinguish the two populations, so the two gaussians converge to very similar means, whose values lie in between the true mean values. This is an inherent problem with fitting multiple gaussians to peaks that are poorly resolved, and is thus not a problem specific to the fitting procedure.

\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=6in]{pyFRET/benchmarking.pdf}
      \caption{{\bf Benchmarking the gaussian fitting process using simulated data.} A) Fitting a two-component Gaussian mixture to a simulated dataset simulating a 1:1 ratio of FRET populations, with FRET efficiencies of 0.4 and 0.6. The two peaks are easily distinguished and fitted correctly. B) Fitting a two-component Gaussian mixture to a simulated dataset simulating a 1:1 ratio of FRET populations, with FRET efficiencies of 0.4 and 0.5. There is significant overlap between the two peaks, so they cannot be distinguished by the fitting algorithm. C) Heatmap showing the relationship between partner FRET efficiency and the error in calculated FRET efficiency. Gaussian fits of datasets where the FRET efficiencies of the two peaks are extremely close to each other are distorted towards an intermediate value. D) One-dimensional representation of the heatmap shown in C), showing the distortion in calculated FRET efficiency when the two components of the mixture have very similar FRET efficiencies.}
      \label{fig:fig_benchmarking}
   \end{center}
\end{figure}

To further quantify the limits of the fitting performance on two population mixtures, we quantified the discrepancy between the true and calculated FRET efficiencies for all peaks fitted, then plotted this discrepancy as a function of the FRET efficiency of the partner peak. The results are shown in Fig.~\ref{fig:fig_benchmarking} C and D. When the two peaks have extremely similar mean FRET efficiencies, the fitting algorithm cannot effectively distinguish them, so both calculated values are distorted towards an intermediate value. However, when the two peaks are well separated, both peaks are fitted correctly, independent of the mean of the partner peak.

Finally, we evaluated the performance of the gaussian fitting on experimental datasets, consisting of a two-component mixture of DNA duplexes. Three duplexes were used for this experiment, namely the duplexes with a 4, 6 and 12 bp dye-dye separation, corresponding to a high-, intermediate- and low-FRET species respectively. The duplexes were mixed in either a 1:3 or 1:1 concentration ratio for data collection using ALEX excitation. We compared the performance of the DCBS algorithm with the simple ALEX event selection on long time bins. Identified bursts were fitted with a two-component mixture of gaussians. The resulting FRET efficiencies and fractional peak areas, shown in Fig.~\ref{fig:ratios} show that DCBS (Fig.~\ref{fig:ratios} A and B) considerably outperforms a simple threshold (Fig.~\ref{fig:ratios} C and D). Whereas DCBS can reliably identify three separate FRET efficiencies (Fig.~\ref{fig:ratios} A) and concentrations (Fig.~\ref{fig:ratios} B), independent of the concentration or FRET efficiency of the partner duplex, the FRET efficiencies (Fig.~\ref{fig:ratios} C) and concentrations (Fig.~\ref{fig:ratios} D) identified by simple ALEX analysis of long time bins are distorted by the partner peak values. Concentrations in this experiment is a proxy for the relative population of states in typical smFRET experiment. Consequently, we conclude that the performance of the gaussian fits are only as good as the prior event selection, and that burst search across short bins outperforms simple thresholding on long bins.

\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=6in]{pyFRET/ratios.pdf}
      \caption{{\bf Using pyFRET to fit multiple fluorescent populations.} ALEX data from mixtures of two DNA duplexes were analysed using pyFRET DCBS (A) and B)) or simple ALEX thresholding on re-binned data (C) and D)), then fitted using a two-component Gaussian mixture model. Three duplexes were used, to provide high-, intermediate- and low-FRET peaks. A) and C) Plot of FRET efficiency vs fractional population, coloured according to the dye-dye separation in the duplex. B) and D) Plot of FRET efficiency vs fractional population, coloured according to the population size.}
      \label{fig:ratios}
   \end{center}
\end{figure}

\subsection{Benchmarking the RASP Algorithm}    
We benchmarked RASP using data collected from a 1:1 mixture of 6 bp (high FRET) and 12 bp (low FRET) duplexes over a period of 10 hours (600 minutes). The parameters used in RASP analysis are shown in Table~\ref{tab:RASP}. RASP allows selection and analysis of bursts that occur within a time interval $\Delta$T after bursts with FRET efficiency in the range $E_{min} - E_{max}$. We demonstrate the correct performance of the RASP algorithm by analysing bursts that occur in 1 ms intervals, centred at the stated times, following a high FRET burst. The resultant FRET histograms are shown in Fig.~\ref{fig:fig9_RASP}. At short recurrence intervals ($T_{max} < 8$ ms), not only do the great majority of events show a high FRET efficiency, but the number of events is greatly increased compared with longer recurrence intervals, demonstrating the enrichment of these events by molecules that have diffused back into the confocal detection volume. 


\begin{figure}[!ht]
   \begin{center}
      \includegraphics*[clip=true, width=6in]{pyFRET/RASP_performance.pdf}
      \caption{{\bf RASP analysis of FRET data from a mixture of a high-FRET and low-FRET duplex.} The black line shows the baseline peak areas for the two duplexes. Other lines show the FRET histograms generated from bursts that occurred at the indicated time following a high-FRET burst. The Recurrence Interval $\Delta$T was 1 ms, centred at the times shown in the legend. Note the greatly increased peak area for high-FRET bursts, demonstrating the recurrence of high-FRET events as molecules diffuse back into the confocal volume.}
      \label{fig:fig9_RASP}
   \end{center}
\end{figure}

\section{Conclusions}
Here we have presented pyFRET, a versatile open source library for analysis of smFRET data. In addition to demonstrating the usage of our event selection and fitting algorithms, we have also thoroughly evaluated their performance. We note that even the sophisticated burst search algorithms are not able to overcome the biases introduced through event selection in simple FRET datasets. ALEX data collection, on the other hand, does not suffer from these biases, so is able to analyse a wide variety of smFRET datasets with considerable accuracy. Furthermore, the burst search algorithms, especially when combined with ALEX data collection, are robust to changes in the values of parameters T, L and M, ensuring that conclusions drawn from smFRET data are not influenced by the thresholding parameters used. We hope that the evaluations and the pyFRET library will be of use to many researchers in the smFRET research field. 
 
\section{Availability and Future Directions}
pyFRET is available to download from PyPI under an open source BSD licence from the Python Package Index (\url{https://pypi.python.org/pypi/pyfret0.1.0}). Documentation can also be found here, whilst a more extensive tutorial, including example scripts, can be found on our website (\url{http://rrm33.user.srcf.net/}) or in the Supplementary Information.

The data and scripts used to showcase and evaluate pyFRET can be found in iPython notebooks XXX.

smFRET is a fast-developing and active research field and we are keen to support scientific progress through development of high-quality usable software. We are keen to work with others to enable their use of and contribution to the pyFRET library. We welcome requests for custom analysis requirements and are happy to support others who wish to contribute additional code to the pyFRET infrastucture. 

The data from DNA duplexes used in evaluating pyFRET can be found in the DataDryad online repository: XXX DOI XXX. iPython Notebooks that reproduce the analysis performed here are also included.

%\section*{Tables}








